name: Use sources and call the CLI testing
on:
  pull_request:
    paths-ignore:
      - '**/cli-tests/**'
      - '**/workflows/cli*'
      - '.gitignore'
      - '**/*.md'
  workflow_dispatch:
    inputs:
      vyper:
        type: string
        description: "vyper version, (repo: https://github.com/vyperlang/vyper/releases) e.g. 0.3.10"
        required: true
        default: "0.3.10"
      commit:
        type: string
        description: "vyper commit, (repo: https://github.com/vyperlang/vyper/releases) e.g. 91361694"
        required: true
        default: "91361694" 

env:
  VYPER_VERSION: ${{ github.event.inputs.vyper || '0.3.10' }}
  VYPER_COMMIT: ${{ github.event.inputs.commit || '91361694' }}


concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build_macos_amd64:
    runs-on: macos-12-large
    outputs:
      VYPER_VERSION: ${{ env.VYPER_VERSION }}
      VYPER_COMMIT: ${{ env.VYPER_COMMIT }}
    env:
      CARGO_NET_GIT_FETCH_WITH_CLI: true
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Prepare environment
        shell: zsh {0}
        run: |
          brew install cmake ninja

      - name: Build LLVM framework
        shell: zsh {0}
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"
        run: |
          cargo install compiler-llvm-builder
          zkevm-llvm clone
          zkevm-llvm build

      - name: Build compiler
        shell: zsh {0}
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"
        run: |
          cargo build --release

      - name: Prepare binary file name
        shell: zsh {0}
        run: |
          mkdir -p ./releases/build_macos_amd64
          mv ./target/release/zkvyper ./releases/build_macos_amd64/zkvyper
    
      - name: Save artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build_macos_amd64
          path: releases

  build_linux_amd64:
    runs-on: [matterlabs-ci-runner]
    outputs:
      VYPER_VERSION: ${{ env.VYPER_VERSION }}
      VYPER_COMMIT: ${{ env.VYPER_COMMIT }}
    container:
      image: matterlabs/llvm_runner:latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - musl
    env:
      CARGO_NET_GIT_FETCH_WITH_CLI: true
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Prepare environment
        run: |
          rustup target add x86_64-unknown-linux-${{ matrix.target }}

      - name: Build LLVM framework
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"
        run: |
          cargo install compiler-llvm-builder --target x86_64-unknown-linux-${{ matrix.target }}
          export PATH="${PATH}:/usr/local/cargo/bin/"
          zkevm-llvm clone
          zkevm-llvm build

      - name: Build compiler
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"
        run: |
          cargo build --release --target x86_64-unknown-linux-${{ matrix.target }}

      - name: Prepare binary file name
        run: |
          mkdir -p releases/build_linux_amd64
          mv ./target/x86_64-unknown-linux-${{ matrix.target }}/release/zkvyper ./releases/build_linux_amd64/zkvyper

      - name: Save artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build_linux_amd64
          path: releases

  build_windows_amd64:
    runs-on: windows-2022-github-hosted-16core
    outputs:
      VYPER_VERSION: ${{ env.VYPER_VERSION }}
      VYPER_COMMIT: ${{ env.VYPER_COMMIT }}
    env:
      CARGO_NET_GIT_FETCH_WITH_CLI: true
      LIBSTDCPP_SOURCE_PATH: "C:/a/_temp/msys64/mingw64/lib/libstdc++.a"
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Prepare msys2
        uses: msys2/setup-msys2@d40200dc2db4c351366b048a9565ad82919e1c24

      - name: Update pacman keys
        shell: msys2 {0}
        run: |
          pacman-key --refresh

      - name: Update pacman deps
        shell: msys2 {0}
        run: |
          pacman -Sy

      - name: Install msys deps
        shell: msys2 {0}
        run: |
          curl -LO https://repo.msys2.org/mingw/mingw64/mingw-w64-x86_64-cmake-3.27.7-3-any.pkg.tar.zst
          pacman --noconfirm -U mingw-w64-x86_64-cmake-3.27.7-3-any.pkg.tar.zst
          pacman --noconfirm -S --needed --overwrite \
          base-devel \
          git \
          ninja \
          mingw-w64-x86_64-clang \
          mingw-w64-x86_64-lld \
          mingw-w64-x86_64-rust \
          mingw-w64-x86_64-gcc-libs \
          mingw-w64-x86_64-gcc

      - name: Build LLVM framework
        shell: msys2 {0}
        run: |
          cargo install compiler-llvm-builder
          export PATH="${PATH}:/c/Users/runneradmin/.cargo/bin/"
          zkevm-llvm clone
          zkevm-llvm build

      - name: Build compiler
        shell: msys2 {0}
        run: |
          cargo build --release

      - name: Prepare binary file name
        run: |
          mkdir -p releases/build_windows_amd64
          mv ./target/release/zkvyper.exe releases/build_windows_amd64/zkvyper.exe

      - name: Save artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build_windows_amd64
          path: releases


  cli_test_linux_amd64:
    needs:
      - build_linux_amd64
    name: CLI tests on linux
    uses: ./.github/workflows/cli_test_run.yaml
    permissions:
        contents: read
    with:
        name: build_linux_amd64
        path: releases
        runner: matterlabs-ci-runner
        vyper_url: https://github.com/vyperlang/vyper/releases/download/${{ needs.build_linux_amd64.outputs.VYPER_VERSION }}/vyper.${{ needs.build_linux_amd64.outputs.VYPER_VERSION }}+commit.${{ needs.build_linux_amd64.outputs.VYPER_COMMIT }}.linux
        

  cli_test_windows:
    needs:
      - build_windows_amd64
    name: CLI tests on Windows
    uses: ./.github/workflows/cli_test_run.yaml
    permissions:
        contents: read
    with:
        name: build_windows_amd64
        path: releases
        runner: windows-2022-github-hosted-16core
        vyper_url: https://github.com/vyperlang/vyper/releases/download/v${{ needs.build_windows_amd64.outputs.VYPER_VERSION }}/vyper.${{ needs.build_windows_amd64.outputs.VYPER_VERSION }}+commit.${{ needs.build_windows_amd64.outputs.VYPER_COMMIT }}.windows.exe

        
  cli_test_macos_amd64:
    needs:
      - build_macos_amd64
    name: CLI tests on macOS
    uses: ./.github/workflows/cli_test_run.yaml
    permissions:
        contents: read
    with:
        name: build_macos_amd64
        path: releases
        runner: macos-12-large
        vyper_url: https://github.com/vyperlang/vyper/releases/download/v${{ needs.build_macos_amd64.outputs.VYPER_VERSION }}/vyper.${{ needs.build_macos_amd64.outputs.VYPER_VERSION }}+commit.${{ needs.build_macos_amd64.outputs.VYPER_COMMIT }}.darwin
