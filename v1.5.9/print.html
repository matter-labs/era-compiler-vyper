<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ZKsync Vyper Compiler Toolchain Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="css/version-box.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKsync Vyper Compiler Toolchain Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="installing-the-zksync-vyper-compiler-toolchain"><a class="header" href="#installing-the-zksync-vyper-compiler-toolchain">Installing the ZKsync Vyper Compiler Toolchain</a></h1>
<p>To compile contracts for ZKsync, you need the ZKsync Vyper compiler toolchain.
It consists of two components:</p>
<ol>
<li>The main component: <a href="https://github.com/matter-labs/era-compiler-vyper/releases"><em>zkvyper</em></a>.</li>
<li>The additional component: <a href="https://github.com/vyperlang/vyper/releases"><em>vyper</em></a>, which produces Vyper artifacts used by <em>zkvyper</em>.</li>
</ol>
<h2 id="system-requirements"><a class="header" href="#system-requirements">System Requirements</a></h2>
<p>It is recommended to have at least 4 GB of RAM to compile large projects. The compilation process is parallelized by default, so the number of threads used is
equal to the number of CPU cores.</p>
<blockquote>
<p>Large projects can consume a lot of RAM during compilation on machines with a high number of cores.
If you encounter memory issues, consider reducing the number of threads using the <code>--threads</code> option.</p>
</blockquote>
<p>The table below outlines the supported platforms and architectures:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">CPU/OS</th><th style="text-align: center">MacOS</th><th style="text-align: center">Linux</th><th style="text-align: center">Windows</th></tr></thead><tbody>
<tr><td style="text-align: center">x86_64</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
<tr><td style="text-align: center">arm64</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td></tr>
</tbody></table>
</div>
<blockquote>
<p>Please avoid using outdated distributions of operating systems, as they may lack the necessary dependencies or include outdated versions of them.
<em>zkvyper</em> is only tested on recent versions of popular distributions, such as MacOS 11.0 and Windows 10.</p>
</blockquote>
<div class="warning">
<a href="https://musl.libc.org">musl</a>-based builds are deprecated, but they are still supported to preserve tooling compatibility.<br>
Starting from <b>zkvyper</b> v1.5.4, we are shipping builds statically linked with <a href="https://www.gnu.org/software/libc/">the GNU C library</a>.
</div>
<h2 id="versioning"><a class="header" href="#versioning">Versioning</a></h2>
<p>The <em>zkvyper</em> versioning scheme does not yet follow the <a href="https://semver.org">Semantic Versioning</a> specification. Instead, its major and minor versions match those of the EraVM protocol for which <em>zkvyper</em> produces bytecode. The patch version is incremented with each release, regardless of whether breaking changes are introduced. Therefore, please consult the changelog before updating the compiler.</p>
<blockquote>
<p>We recommend always using the latest version of <em>zkvyper</em> and <em>vyper</em> to benefit from the latest features and bug fixes.</p>
</blockquote>
<h2 id="installing-zkvyper"><a class="header" href="#installing-zkvyper">Installing <em>zkvyper</em></a></h2>
<p>You can install the ZKsync Vyper compiler toolchain using the following methods:</p>
<ol>
<li>Use Foundry, Hardhat, or other popular toolkits, so they will manage the compiler installation and their dependencies for you. See <a href="01-installation.html#ethereum-development-toolkits">Ethereum Development Toolkits</a>.</li>
<li>Download pre-built binaries of <a href="https://github.com/vyperlang/vyper/releases"><em>vyper</em></a> and <a href="https://github.com/matter-labs/era-compiler-vyper/releases"><em>zkvyper</em></a>. See <a href="01-installation.html#static-executables">Static Executables</a>.</li>
<li>Build <em>zkvyper</em> from sources. See <a href="01-installation.html#building-from-source">Building from Source</a>.</li>
</ol>
<blockquote>
<p>For small projects, learning and research purposes, <em>zkvyper</em> and <em>vyper</em> executables without a toolkit are sufficient.</p>
</blockquote>
<h2 id="installing-vyper"><a class="header" href="#installing-vyper">Installing <em>vyper</em></a></h2>
<p>Running <em>zkvyper</em> requires the <a href="https://github.com/vyperlang/vyper/releases">Vyper compiler <em>vyper</em></a>, which is called by <em>zkvyper</em> as a child process. To point <em>zkvyper</em> to the location of <em>vyper</em>, use one of the following methods:</p>
<ol>
<li>
<p>Add the location of <em>vyper</em> to the environment variable <code>PATH</code>.</p>
<p>For example, if you have downloaded <em>vyper</em> to the directory <code>/home/username/opt</code>,
you can execute the following command, or append it to the configuration file of your shell:</p>
<pre><code class="language-shell">export PATH="/home/username/opt:${PATH}"
</code></pre>
</li>
<li>
<p>Alternatively, when you run <em>zkvyper</em>, provide the full path to <em>vyper</em> using the <code>--vyper</code> option.</p>
<p>For example, if <code>vyper</code> is located in your current working directory, you can point to it with this command:</p>
<pre><code class="language-shell">zkvyper --vyper './vyper' --bin 'Greeter.vy'
</code></pre>
</li>
</ol>
<blockquote>
<p>The second option is more convenient if you are using different versions of <em>vyper</em> for different projects.
<em>zkvyper</em> only supports <em>vyper</em> of versions 0.3.3 and 0.3.9 and newer, but does not support versions from 0.3.4 to 0.3.8.</p>
</blockquote>
<h2 id="ethereum-development-toolkits"><a class="header" href="#ethereum-development-toolkits">Ethereum Development Toolkits</a></h2>
<p>For large codebases, it is more convenient to use the ZKsync compiler toolchain via toolkits like Foundry and Hardhat.
These tools manage the compiler executables and their dependencies, and provide additional features like incremental compilation and caching.</p>
<p>The ZKsync toolchain is supported by the following toolkits:</p>
<p><em>TODO: Add links to the tutorials</em></p>
<h2 id="static-executables"><a class="header" href="#static-executables">Static Executables</a></h2>
<p>We ship <em>zkvyper</em> binaries on the <a href="https://github.com/matter-labs/era-compiler-vyper/releases">releases page of <code>matter-labs/era-compiler-vyper</code> repository</a>.
This repository maintains intuitive and stable naming for the executables and provides a changelog for each release. Tools using <em>zkvyper</em> will download the binaries from this repository and cache them locally.</p>
<div class="warning">
The <a href="https://github.com/matter-labs/era-compiler-vyper">matter-labs/era-compiler-vyper</a> repository only contains builds for versions 1.4.0 and newer.<br>
You can download older versions from <a href="https://github.com/matter-labs/zkvyper-bin/tree/main">the main branch</a> or <a href="https://github.com/matter-labs/zkvyper-bin/releases">the releases page</a> of the deprecated repository for zkvyper executables.<br>
If any of your projects are still using the old locations, please change their download URLs to <a href="https://github.com/matter-labs/era-compiler-vyper/releases">the new one</a>.
</div>
<blockquote>
<p>All binaries are statically linked and must work on all recent platforms without issues.
<em>zkvyper</em> is fully written in Rust, aiming to minimize incompatibilities with the environment.</p>
</blockquote>
<h2 id="building-from-source"><a class="header" href="#building-from-source">Building from Source</a></h2>
<blockquote>
<p>Please consider using the pre-built executables before building from source.
Building from source is only necessary for development, research, and debugging purposes.
Deployment and production use cases should rely only on <a href="01-installation.html#static-executables">the officially released executables</a>.</p>
</blockquote>
<ol>
<li>
<p>Install the necessary system-wide dependencies.</p>
<ul>
<li>For Linux (Debian):</li>
</ul>
<pre><code class="language-shell">apt install cmake ninja-build curl git libssl-dev pkg-config clang lld
</code></pre>
<ul>
<li>For Linux (Arch):</li>
</ul>
<pre><code class="language-shell">pacman -Syu which cmake ninja curl git pkg-config clang lld
</code></pre>
<ul>
<li>
<p>For MacOS:</p>
<ol>
<li>
<p>Install the <em>Homebrew</em> package manager by following the instructions at <a href="https://brew.sh">brew.sh</a>.</p>
</li>
<li>
<p>Install the necessary system-wide dependencies:</p>
<pre><code class="language-shell">brew install cmake ninja coreutils
</code></pre>
</li>
<li>
<p>Install a recent build of the LLVM/<a href="https://clang.llvm.org">Clang</a> compiler using one of the following tools:</p>
<ul>
<li><a href="https://developer.apple.com/xcode/">Xcode</a></li>
<li><a href="https://developer.apple.com/library/archive/technotes/tn2339/_index.html">Apple’s Command Line Tools</a></li>
<li>Your preferred package manager.</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li>
<p>Install Rust.</p>
<p>The easiest way to do it is following the latest <a href="https://www.rust-lang.org/tools/install">official instructions</a>.</p>
</li>
</ol>
<blockquote>
<p>The Rust version used for building is pinned in the <a href="../rust-toolchain.toml">rust-toolchain.toml</a> file at the repository root.
<em>cargo</em> will automatically download the pinned version of <em>rustc</em> when you start building the project.</p>
</blockquote>
<ol start="3">
<li>
<p>Clone and checkout this repository.</p>
<pre><code class="language-shell">git clone https://github.com/matter-labs/era-compiler-vyper
</code></pre>
</li>
<li>
<p>Install the ZKsync LLVM framework builder. This tool clones the <a href="https://github.com/matter-labs/era-compiler-llvm">repository of ZKsync LLVM Framework</a> and runs a sequence of build commands tuned for the needs of ZKsync compiler toolchain.</p>
<pre><code class="language-shell">cargo install compiler-llvm-builder
</code></pre>
<p>To fine-tune your build of ZKsync LLVM framework, refer to the section <a href="01-installation.html#fine-tuning-zksync-llvm-build">Fine tuning ZKsync LLVM build</a></p>
</li>
</ol>
<blockquote>
<p>Always use the latest version of the builder to benefit from the latest features and bug fixes.
To check for new versions and update the builder, simply run <code>cargo install compiler-llvm-builder</code> again, even if you have already installed the builder.
The builder is not the ZKsync LLVM framework itself, but a tool to build it.
By default, it is installed in <code>~/.cargo/bin/</code>, which is usually added to your <code>PATH</code> during the Rust installation process.</p>
</blockquote>
<ol start="5">
<li>
<p>Clone and build the ZKsync LLVM framework using the <code>zksync-llvm</code> tool.</p>
<pre><code class="language-shell"># Navigate to the root of your local copy of this repository.
cd era-compiler-vyper
# Clone the ZKsync LLVM framework. The branch is specified in the file `LLVM.lock`.
zksync-llvm clone
# Build the ZKsync LLVM framework.
zksync-llvm build
</code></pre>
<p>For more information and available build options, run <code>zksync-llvm build --help</code>.</p>
<p>You can also clone and build LLVM framework outside of the repository root.
In this case, do the following:</p>
<ol>
<li>
<p>Provide an <code>LLVM.lock</code> file in the directory where you run <code>zksync-llvm</code>.
See the <a href="../LLVM.lock">default LLVM.lock for an example</a>.</p>
</li>
<li>
<p>Ensure that <code>LLVM.lock</code> selects the correct branch of the <a href="https://github.com/matter-labs/era-compiler-llvm">ZKsync LLVM Framework repository</a>.</p>
</li>
<li>
<p>Before proceeding to the next step, set the environment variable <code>LLVM_SYS_170_PREFIX</code> to the path of the directory with the LLVM build artifacts.
Typically, it ends with <code>target-llvm/build-final</code>, which is the default LLVM target directory of the LLVM builder. For example:</p>
<pre><code class="language-shell">export LLVM_SYS_170_PREFIX=~/repositories/era-compiler-vyper/target-llvm/build-final 
</code></pre>
</li>
</ol>
</li>
<li>
<p>Build the <em>zkvyper</em> executable.</p>
<pre><code class="language-shell">cargo build --release
</code></pre>
<p>The <em>zkvyper</em> executable will appear at <code>./target/release/zkvyper</code>, where you can run it directly or move it to another location.</p>
<p>If <em>cargo</em> cannot find the LLVM build artifacts, return to the previous step and ensure that the <code>LLVM_SYS_170_PREFIX</code> environment variable is set to the absolute path of the directory <code>target-llvm/build-final</code>.</p>
</li>
</ol>
<h2 id="tuning-the-zksync-llvm-build"><a class="header" href="#tuning-the-zksync-llvm-build">Tuning the ZKsync LLVM build</a></h2>
<ul>
<li>
<p>For more information and available build options, run <code>zksync-llvm build --help</code>.</p>
</li>
<li>
<p>Use the <code>--use-ccache</code> option to speed up the build process if you have <a href="https://ccache.dev">ccache</a> installed.</p>
</li>
<li>
<p>To build ZKsync LLVM framework using specific C and C++ compilers, pass additional arguments to <a href="https://cmake.org/">CMake</a> using the <code>--extra-args</code> option:</p>
<pre><code class="language-shell"># Pay special attention to character escaping.

zksync-llvm build \
  --use-ccache \
  --extra-args \
    '\-DCMAKE_C_COMPILER=/opt/homebrew/Cellar/llvm@18/18.1.8/bin/clang' \
    '\-DCMAKE_BUILD_TYPE=Release' \
    '\-DCMAKE_CXX_COMPILER=/opt/homebrew/Cellar/llvm@18/18.1.8/bin/clang++' 
</code></pre>
</li>
</ul>
<h3 id="building-llvm-manually"><a class="header" href="#building-llvm-manually">Building LLVM manually</a></h3>
<ul>
<li>
<p>If you prefer building <a href="https://github.com/matter-labs/era-compiler-llvm">your ZKsync LLVM</a> manually, include the following flags in your CMake command:</p>
<pre><code class="language-shell"># We recommended using the latest version of CMake.

-DLLVM_TARGETS_TO_BUILD='EraVM;EVM'
-DLLVM_ENABLE_PROJECTS='lld'
-DBUILD_SHARED_LIBS='Off'
</code></pre>
</li>
</ul>
<blockquote>
<p>For most users, the <a href="01-installation.html#building-from-source">ZKsync LLVM builder</a> is the recommended way to build the ZKsync LLVM framework.
This section exists for the ZKsync toolchain developers and researchers with specific requirements and experience with the LLVM framework.
We are going to present a more detailed guide for LLVM contributors in the future.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="command-line-interface-cli"><a class="header" href="#command-line-interface-cli">Command Line Interface (CLI)</a></h1>
<p>The CLI of <em>zkvyper</em> is designed with resemblance to the CLI of <em>vyper</em>. There are two input/output (I/O) modes in the <em>zkvyper</em> interface:</p>
<ul>
<li><a href="02-command-line-interface.html#basic-cli">Basic CLI</a></li>
<li><a href="./03-combined-json.html">Combined JSON</a></li>
</ul>
<blockquote>
<p>All toolkits using <em>zkvyper</em> must be operating in combined JSON mode and follow <a href="./03-combined-json.html">its specification</a>.
It will make the toolkits more robust and future-proof, as the combined JSON mode is the most versatile and used for the majority of popular projects.</p>
</blockquote>
<p>This page focuses on the basic CLI mode. For more information on combined JSON, see <a href="./03-combined-json.html">this page</a>.</p>
<h2 id="basic-cli"><a class="header" href="#basic-cli">Basic CLI</a></h2>
<p>Basic CLI mode is the simplest way to compile a file with the source code.</p>
<p>To compile a basic Vyper contract, make sure that <a href="02-command-line-interface.html#--vyper">the <em>vyper</em> compiler</a> is present in your environment and run <a href="02-command-line-interface.html#--vyper">the example</a>.</p>
<p>The rest of this section describes the available CLI options and their usage. You may also check out <code>zkvyper --help</code> for a quick reference.</p>
<h3 id="--vyper"><a class="header" href="#--vyper"><code>--vyper</code></a></h3>
<p>Specifies the path to the <em>vyper</em> compiler. Useful when the <em>vyper</em> compiler is not available in the system path.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --vyper '/path/to/vyper'
</code></pre>
<blockquote>
<p>Examples in the subsequent sections assume that <em>vyper</em> <a href="./01-installation.html#installing-vyper">is installed and available</a> in the system path.
If you prefer specifying the full path to <em>vyper</em>, use the <code>--vyper</code> option with the examples below.</p>
</blockquote>
<h3 id="input-files"><a class="header" href="#input-files">Input Files</a></h3>
<p><em>zkvyper</em> supports multiple input files. The following command compiles two Vyper files and prints the bytecode:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' './Complex.vy'
</code></pre>
<h3 id="--format---f"><a class="header" href="#--format---f"><code>--format</code> / <code>-f</code></a></h3>
<p>This option can be used for two purposes:</p>
<ol>
<li>Switch to <a href="./03-combined-json.html">combined JSON mode</a>.</li>
<li>Select the desired output in <a href="02-command-line-interface.html#basic-cli">basic CLI mode</a>.</li>
</ol>
<p>In basic CLI mode, the following selectors are available:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Selector</th><th style="text-align: center">Source</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td style="text-align: center">combined_json</td><td style="text-align: center">both</td><td style="text-align: center">Switches to <a href="./03-combined-json.html">combined JSON mode</a>. Cannot be used with other selectors.</td></tr>
<tr><td style="text-align: center">ir_json</td><td style="text-align: center">vyper</td><td style="text-align: center">Vyper LLL IR that is used by <em>zkvyper</em> to produce LLVM IR.</td></tr>
<tr><td style="text-align: center">ast</td><td style="text-align: center">vyper</td><td style="text-align: center">Abstract Syntax Tree (AST) of the Vyper source code.</td></tr>
<tr><td style="text-align: center">abi</td><td style="text-align: center">vyper</td><td style="text-align: center">Application Binary Interface (ABI) of the Vyper contract.</td></tr>
<tr><td style="text-align: center">method_identifiers</td><td style="text-align: center">vyper</td><td style="text-align: center">Hashes of function signature of the Vyper contract.</td></tr>
<tr><td style="text-align: center">layout</td><td style="text-align: center">vyper</td><td style="text-align: center">Storage and code layouts of the Vyper contract.</td></tr>
<tr><td style="text-align: center">userdoc</td><td style="text-align: center">vyper</td><td style="text-align: center">User documentation of the Vyper contract.</td></tr>
<tr><td style="text-align: center">devdoc</td><td style="text-align: center">vyper</td><td style="text-align: center">Developer documentation of the Vyper contract.</td></tr>
<tr><td style="text-align: center">eravm_assembly</td><td style="text-align: center">zkvyper</td><td style="text-align: center">EraVM assembly of the Vyper contract.</td></tr>
<tr><td style="text-align: center">project_metadata</td><td style="text-align: center">zkvyper</td><td style="text-align: center">Project metadata of the Vyper contract.</td></tr>
</tbody></table>
</div>
<blockquote>
<p>Some data above is produced by <em>vyper</em>, whereas the rest is produced by <em>zkvyper</em>, as designated in the <em>Source</em> column.</p>
</blockquote>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --format 'ir_json,ast,abi,method_identifiers,layout,userdoc,devdoc,eravm_assembly,project_metadata'
</code></pre>
<p>Output:</p>
<pre><code class="language-text">Contract `/Users/hedgarmac/src/era-compiler-tester//tests/vyper/simple/default.vy`:
0x0000000100200190000000110000c13d0000000a001001980000001d0000613d...(truncated)
{"seq":[(truncated)]}
{"contract_name":"/Users/hedgarmac/src/era-compiler-tester/tests/vyper/simple/default.vy","ast":{(truncated)}}
[{"inputs":[],"name":"first","outputs":[{"name":"","type":"uint8"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"second","outputs":[{"name":"","type":"uint256"}],"stateMutability":"pure","type":"function"}]
{"first()":"0x3df4ddf4","second()":"0x5a8ac02d"}
{}
{}
{}
Contract `/Users/hedgarmac/src/era-compiler-tester//tests/vyper/simple/default.vy` assembly:
        .text
        .file   "default.vy"
        .globl  __entry
__entry:
.func_begin0:
        and!    1, r2, r0
        jump.ne @.BB0_9
        and!    code[@CPI0_1], r1, r0
        jump.eq @.BB0_10
... (truncated)

Project metadata:
{"evm_version":"cancun","llvm_options":[],"optimizer_settings":"M3B3","source_code_hash":[147,242,126,144,(truncated),22,153,132,218],"source_version":"0.4.0","zk_version":"1.5.8"}
</code></pre>
<p>The output order above is fixed and cannot be changed by the order of the selectors in the <code>--format</code> argument:</p>
<ol>
<li>Bytecode</li>
<li>LLL IR JSON</li>
<li>AST</li>
<li>ABI</li>
<li>Method identifiers</li>
<li>Layout</li>
<li>User documentation</li>
<li>Developer documentation</li>
<li>EraVM assembly</li>
<li>Project metadata</li>
</ol>
<h3 id="--output-dir"><a class="header" href="#--output-dir"><code>--output-dir</code></a></h3>
<p>Specifies the output directory for build artifacts. Can only be used in <a href="02-command-line-interface.html#basic-cli">basic CLI</a> and <a href="./03-combined-json.html">combined JSON</a> modes.</p>
<p>Usage in basic CLI mode:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --output-dir './build/'
ls './build/'
</code></pre>
<p>Output:</p>
<pre><code class="language-text">default.vy.zbin
</code></pre>
<p>Usage in combined JSON mode:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --format 'combined_json' --output-dir './build/'
ls './build/'
</code></pre>
<p>Output:</p>
<pre><code class="language-text">combined.json
</code></pre>
<h3 id="--overwrite"><a class="header" href="#--overwrite"><code>--overwrite</code></a></h3>
<p>Overwrites the output files if they already exist in the output directory. By default, <em>zkvyper</em> does not overwrite existing files.</p>
<p>Can only be used in combination with the <a href="02-command-line-interface.html#--output-dir"><code>--output-dir</code></a> option.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --format 'combined_json' --output-dir './build/' --overwrite
</code></pre>
<p>If the <code>--overwrite</code> option is not specified and the output files already exist, <em>zkvyper</em> will print an error message and exit:</p>
<pre><code class="language-text">Refusing to overwrite an existing file "./build/combined.json" (use --overwrite to force).
</code></pre>
<h3 id="--version"><a class="header" href="#--version"><code>--version</code></a></h3>
<p>Prints the version of <em>zkvyper</em> and the hash of the LLVM commit it was built with.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper --version
</code></pre>
<h3 id="--help"><a class="header" href="#--help"><code>--help</code></a></h3>
<p>Prints the help message.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper --help
</code></pre>
<h2 id="other-io-modes"><a class="header" href="#other-io-modes">Other I/O Modes</a></h2>
<p>To switch to combined JSON mode, use <a href="02-command-line-interface.html#--format---f">the <code>--format</code> option</a> with the <code>combined_json</code> argument:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --format 'combined_json'
</code></pre>
<p>The mode-altering CLI options are mutually exclusive. This means that only one of the options below can be enabled at a time:</p>
<ul>
<li><code>--format</code> / <code>-f</code></li>
<li><code>--llvm-ir</code></li>
<li><code>--eravm-assembly</code></li>
<li><code>--disassemble</code></li>
</ul>
<h2 id="zkvyper-compilation-settings"><a class="header" href="#zkvyper-compilation-settings"><em>zkvyper</em> Compilation Settings</a></h2>
<p>The options in this section are only configuring the <em>zkvyper</em> compiler and do not affect the underlying <em>vyper</em> compiler.</p>
<h3 id="--optimization---o"><a class="header" href="#--optimization---o"><code>--optimization / -O</code></a></h3>
<p>Sets the optimization level of the LLVM optimizer. Available values are:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Level</th><th style="text-align: center">Meaning</th><th style="text-align: center">Hints</th></tr></thead><tbody>
<tr><td style="text-align: center">0</td><td style="text-align: center">No optimization</td><td style="text-align: center">Best compilation speed: for active development</td></tr>
<tr><td style="text-align: center">1</td><td style="text-align: center">Performance: basic</td><td style="text-align: center">For optimization research</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center">Performance: default</td><td style="text-align: center">For optimization research</td></tr>
<tr><td style="text-align: center">3</td><td style="text-align: center">Performance: aggressive</td><td style="text-align: center">Default value. Best performance: for production</td></tr>
<tr><td style="text-align: center">s</td><td style="text-align: center">Size: default</td><td style="text-align: center">For optimization research</td></tr>
<tr><td style="text-align: center">z</td><td style="text-align: center">Size: aggressive</td><td style="text-align: center">Best size: for contracts with size constraints</td></tr>
</tbody></table>
</div>
<p>For most cases, it is fine to use the default value of <code>3</code>. You should only use the level <code>z</code> if you are ready to deliberately sacrifice performance and optimize for size.</p>
<blockquote>
<p>Large contracts may hit the EraVM or EVM bytecode size limit. In this case, it is recommended to use the <a href="02-command-line-interface.html#--fallback-oz"><code>--fallback-Oz</code></a> option rather than set the <code>z</code> level.</p>
</blockquote>
<h3 id="--fallback-oz"><a class="header" href="#--fallback-oz"><code>--fallback-Oz</code></a></h3>
<p>Sets the optimization level to <code>z</code> for contracts that failed to compile due to overrunning the bytecode size constraints.</p>
<p>Under the hood, this option automatically triggers recompilation of contracts with level <code>z</code>. Contracts that were successfully compiled with <a href="02-command-line-interface.html#--optimization---o">the original <code>--optimization</code> setting</a> are not recompiled.</p>
<blockquote>
<p>It is recommended to have this option always enabled to prevent compilation failures due to bytecode size constraints. There are no known downsides to using this option.</p>
</blockquote>
<h3 id="--metadata-hash"><a class="header" href="#--metadata-hash"><code>--metadata-hash</code></a></h3>
<p>Specifies the hash function used for project metadata.</p>
<div class="warning">
For security reasons, the source code of all input Vyper contracts are hashed together, so a change in one contract will affect the metadata hash appended to the bytecode of all contracts, even if there are no dependency relations between them.
It may be changed in the future, so each contract will be hashed separately just like *vyper* does.
</div>
<p>The following values are allowed:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Value</th><th style="text-align: center">Size</th><th style="text-align: center">Padding</th><th style="text-align: center">Reference</th></tr></thead><tbody>
<tr><td style="text-align: center">none</td><td style="text-align: center">0 B</td><td style="text-align: center">0-32 B</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">keccak256</td><td style="text-align: center">32 B</td><td style="text-align: center">0-32 B</td><td style="text-align: center"><a href="https://en.wikipedia.org/wiki/SHA-3">SHA-3 Wikipedia Page</a></td></tr>
<tr><td style="text-align: center">ipfs</td><td style="text-align: center">44 B</td><td style="text-align: center">20-52 B</td><td style="text-align: center"><a href="https://docs.ipfs.tech/">IPFS Documentation</a></td></tr>
</tbody></table>
</div>
<p>The default value is <code>keccak256</code>.</p>
<blockquote>
<p>EraVM requires its bytecode size to be an odd number of 32-byte words. If the size after appending the hash does not satisfy this requirement, the hash is <em>prepended</em> with zeros according to the <em>Padding</em> column in the table above.</p>
</blockquote>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --metadata-hash 'ipfs'
</code></pre>
<h3 id="--suppress-warnings"><a class="header" href="#--suppress-warnings"><code>--suppress-warnings</code></a></h3>
<p>Tells the compiler to suppress specified warnings. The option accepts multiple string arguments, so make sure they are properly separated by whitespace.</p>
<p>Only one warning can be suppressed with this option: <a href="https://docs.zksync.io/build/tooling/foundry/migration-guide/testing#origin-address"><code>txorigin</code></a>.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --suppress-warnings 'txorigin'
</code></pre>
<h3 id="--llvm-options"><a class="header" href="#--llvm-options"><code>--llvm-options</code></a></h3>
<p>Specifies additional options for the LLVM framework. The argument must be a single quoted string following a <code>=</code> separator.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --llvm-options='-eravm-jump-table-density-threshold=10'
</code></pre>
<blockquote>
<p>The <code>--llvm-options</code> option is experimental and must only be used by experienced users. All supported options will be documented in the future.</p>
</blockquote>
<h2 id="vyper-compilation-settings"><a class="header" href="#vyper-compilation-settings"><em>vyper</em> Compilation Settings</a></h2>
<p>The options in this section are only configuring <em>vyper</em>, so they are passed directly to its child process, and do not affect the <em>zkvyper</em> compiler.</p>
<h3 id="--evm-version"><a class="header" href="#--evm-version"><code>--evm-version</code></a></h3>
<p>Specifies the EVM version <em>vyper</em> will produce artifacts for. Only LLL IR is known to be affected by this option. For instance, if the EVM version is set to <em>cancun</em>, the LLL IR may contain <code>mcopy</code> instructions.</p>
<blockquote>
<p>EVM version only affects IR artifacts produced by <em>vyper</em> and does not affect EraVM bytecode produced by <em>zkvyper</em>.</p>
</blockquote>
<p>The following values are allowed by <em>zkvyper</em>:</p>
<ul>
<li>homestead</li>
<li>tangerineWhistle</li>
<li>spuriousDragon</li>
<li>byzantium</li>
<li>constantinople</li>
<li>petersburg</li>
<li>istanbul</li>
<li>berlin</li>
<li>london</li>
<li>paris</li>
<li>shanghai</li>
<li>cancun</li>
<li>prague</li>
</ul>
<blockquote>
<p>However, have in mind that many of them are not supported by <em>vyper</em>, or only supported by its newer versions.
For instance, the <code>--help</code> message of <em>vyper</em> v0.4.0 only declares the following EVM versions as supported: <em>london</em>, <em>paris</em>, <em>shanghai</em>, <em>cancun</em>.
For the full list of supported EVM versions, refer to <a href="https://docs.vyperlang.org/en/stable/">the official <em>vyper</em> documentation</a>.</p>
</blockquote>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --evm-version 'cancun'
</code></pre>
<h3 id="--disable-vyper-optimizer"><a class="header" href="#--disable-vyper-optimizer"><code>--disable-vyper-optimizer</code></a></h3>
<p>Disables the optimizer of the <em>vyper</em> compiler.</p>
<p>The optimizer is enabled by default for <em>vyper</em> v0.3.x. For <em>vyper</em> v0.4.x it is disabled and cannot be enabled, as the optimized LLL IR is not compatible with <em>zkvyper</em>.</p>
<blockquote>
<p><em>zkvyper</em> relies on the LLVM optimizer, so the <em>vyper</em> optimizer is not affecting the size or performance of the final bytecode significantly.</p>
</blockquote>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --disable-vyper-optimizer
</code></pre>
<h3 id="--enable-decimals"><a class="header" href="#--enable-decimals"><code>--enable-decimals</code></a></h3>
<p>Enables <a href="https://docs.vyperlang.org/en/stable/types.html#decimals">decimals</a> in <em>vyper</em> v0.4.0.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --enable-decimals
</code></pre>
<h3 id="--search-paths"><a class="header" href="#--search-paths"><code>--search-paths</code></a></h3>
<p>Passes additional <a href="https://docs.vyperlang.org/en/stable/structure-of-a-contract.html#searching-for-imports">search paths</a> to <em>vyper</em>.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --search-paths '/path/to/libraries-1/' '/path/to/libraries-2/'
</code></pre>
<h2 id="multi-language-support"><a class="header" href="#multi-language-support">Multi-Language Support</a></h2>
<p><em>zkvyper</em> supports input in multiple programming languages:</p>
<ul>
<li><a href="https://vyperlang.org/">Vyper</a></li>
<li><a href="https://llvm.org/docs/LangRef.html">LLVM IR</a></li>
<li><a href="https://docs.zksync.io/zk-stack/components/compiler/specification/binary-layout">EraVM assembly</a></li>
</ul>
<p>The following sections outline how to use <em>zkvyper</em> with these languages.</p>
<h3 id="--llvm-ir"><a class="header" href="#--llvm-ir"><code>--llvm-ir</code></a></h3>
<p>Enables the LLVM IR mode. In this mode, input is expected to be in the LLVM IR language. The output works the same way as with Vyper input.</p>
<p>Unlike <em>vyper</em>, <em>zkvyper</em> is an LLVM-based compiler toolchain, so it uses LLVM IR as an intermediate representation. It is not recommended to write LLVM IR manually, but it can be useful for debugging and optimization purposes. LLVM IR is more low-level than Vyper LLL in the ZKsync compiler toolchain IR hierarchy, so <em>vyper</em> is not used for compilation.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper --llvm-ir './Simple.ll'
</code></pre>
<p>Output:</p>
<pre><code class="language-text">Contract `&lt;absolute-path&gt;/Simple.ll`:
0x000000000002004b000000070000613d000000200100003900000000001004...
</code></pre>
<h3 id="--eravm-assembly"><a class="header" href="#--eravm-assembly"><code>--eravm-assembly</code></a></h3>
<p>Enables the EraVM Assembly mode. In this mode, input is expected to be in the EraVM assembly language. The output works the same way as with Vyper input.</p>
<p>EraVM assembly is a representation the closest to EraVM bytecode. It is not recommended to write EraVM assembly manually, but it can be even more useful for debugging and optimization purposes than LLVM IR.</p>
<p>For the EraVM assembly specification, visit the <a href="https://docs.zksync.io/zk-stack/components/compiler/specification/binary-layout">EraVM documentation</a>.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper --eravm-assembly './Simple.zasm'
</code></pre>
<p>Output:</p>
<pre><code class="language-text">Contract `&lt;absolute-path&gt;/Simple.zasm`:
0x000000000120008c000000070000613d00000020010000390000000000100435000000000001043500000005010000410000000c0001042e0000002a01000039000000000010043500000004010000410000000c0001042e0000000b000004320000000c0001042e0000000d00010430000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000043bbf1d8e1b7b1d452f006fe83028ba3b7853f9ea8a4635f4c584fe1dc6429b5
</code></pre>
<h2 id="integrated-tooling"><a class="header" href="#integrated-tooling">Integrated Tooling</a></h2>
<p><em>zkvyper</em> includes several tools provided by the LLVM framework out of the box, such as disassembler and linker. The following sections describe the usage of these tools.</p>
<h3 id="--disassemble"><a class="header" href="#--disassemble"><code>--disassemble</code></a></h3>
<p>Enables the disassembler mode.</p>
<p><em>zkvyper</em> includes an LLVM-based disassembler that can be used to disassemble compiled bytecode.</p>
<p>The disassembler input must be files with a hexadecimal string. The disassembler output is a human-readable representation of the bytecode, also known as EraVM assembly.</p>
<p>Usage:</p>
<pre><code class="language-shell">cat './input.zbin'
</code></pre>
<p>Output:</p>
<pre><code class="language-text">0x0000008003000039000000400030043f0000000100200190000000140000c13d00000000020...
</code></pre>
<pre><code class="language-shell">zkvyper --disassemble './input.zbin'
</code></pre>
<p>Output:</p>
<pre><code class="language-text">File `input.zbin` disassembly:

       0: 00 00 00 80 03 00 00 39       add     128, r0, r3
       8: 00 00 00 40 00 30 04 3f       stm.h   64, r3
      10: 00 00 00 01 00 20 01 90       and!    1, r2, r0
      18: 00 00 00 14 00 00 c1 3d       jump.ne 20
      20: 00 00 00 00 02 01 00 19       add     r1, r0, r2
      28: 00 00 00 0b 00 20 01 98       and!    code[11], r2, r0
      30: 00 00 00 23 00 00 61 3d       jump.eq 35
      38: 00 00 00 00 01 01 04 3b       ldp     r1, r1
</code></pre>
<h2 id="debugging"><a class="header" href="#debugging">Debugging</a></h2>
<h3 id="--debug-output-dir"><a class="header" href="#--debug-output-dir"><code>--debug-output-dir</code></a></h3>
<p>Specifies the directory to store intermediate build artifacts. The artifacts can be useful for debugging and research.</p>
<p>The directory is created if it does not exist. If artifacts are already present in the directory, they are overwritten.</p>
<p>The intermediate build artifacts can be:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Name</th><th style="text-align: center">File extension</th></tr></thead><tbody>
<tr><td style="text-align: center">LLL</td><td style="text-align: center"><em>lll</em></td></tr>
<tr><td style="text-align: center">LLVM IR</td><td style="text-align: center"><em>ll</em></td></tr>
<tr><td style="text-align: center">EraVM assembly</td><td style="text-align: center"><em>zasm</em></td></tr>
</tbody></table>
</div>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --debug-output-dir './debug/'
ls './debug/'
</code></pre>
<p>Output:</p>
<pre><code class="language-text">&lt;absolute-path-with-underscores&gt;_Simple.vy.lll
&lt;absolute-path-with-underscores&gt;_Simple.vy.runtime.optimized.ll
&lt;absolute-path-with-underscores&gt;_Simple.vy.runtime.unoptimized.ll
&lt;absolute-path-with-underscores&gt;_Simple.vy.zasm
</code></pre>
<p>The output file name is constructed as follows: <code>&lt;AbsoluteContractPathWithUnderscores&gt;_&lt;ContractName&gt;.&lt;Modifiers&gt;.&lt;Extension&gt;</code>.</p>
<h3 id="--llvm-verify-each"><a class="header" href="#--llvm-verify-each"><code>--llvm-verify-each</code></a></h3>
<p>Enables the verification of the LLVM IR after each optimization pass. This option is useful for debugging and research purposes.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --llvm-verify-each
</code></pre>
<h3 id="--llvm-debug-logging"><a class="header" href="#--llvm-debug-logging"><code>--llvm-debug-logging</code></a></h3>
<p>Enables the debug logging of the LLVM IR optimization passes. This option is useful for debugging and research purposes.</p>
<p>Usage:</p>
<pre><code class="language-shell">zkvyper './Simple.vy' --llvm-debug-logging
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="combined-json"><a class="header" href="#combined-json">Combined JSON</a></h1>
<p>Combined JSON is an I/O mode designed as a convenient way of using <em>zkvyper</em> from tooling that call it as a child process. In this mode, input data is provided via the CLI, and JSON output can be easily read by both humans and programs.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>To enable combined JSON, pass the <code>-f combined_json</code> option to <em>zkvyper</em>:</p>
<pre><code class="language-shell">zkvyper './MyContract.vy' --format 'combined_json'
</code></pre>
<div class="warning">
It is only possible to use Combined JSON with Vyper input, so the path to <b>vyper</b> must be always provided to *zkvyper*.
Support for other languages is planned for future releases.
</div>
<h2 id="output-format"><a class="header" href="#output-format">Output Format</a></h2>
<p>The format below is a modification of the original combined JSON output format implemented by <em>vyper</em>. It means that there are:</p>
<ul>
<li><em>zkvyper</em>-specific options that are not present in the original format: they are marked as <em>zkvyper</em> in the specification below.</li>
<li><em>vyper</em>-specific options that are not supported by <em>zkvyper</em>: they are not mentioned in the specification below.</li>
</ul>
<blockquote>
<p><em>zkvyper</em> always produces absolute contract paths in combined JSON output. It was done for unification purposes, as various versions of <em>vyper</em> are known to produce either absolute or relative paths.</p>
</blockquote>
<pre><code class="language-javascript">{
  "&lt;absolute-path&gt;/MyContract.vy": {
    // The bytecode as a hexadecimal string.
    "bytecode": "0000008003000039000000400030043f0000000100200190000000130000c13d...",
    // For EraVM, same as "bytecode".
    "bytecode_runtime": "0000008003000039000000400030043f0000000100200190000000130000c13d...",
    // Contract Vyper LLL IR, used by zkvyper to produce LLVM IR.
    "ir_json": {/* ... */},
    // Contract AST.
    "ast": {/* ... */},
    // Hashes of function signatures.
    "method_identifiers": {/* ... */},
    // Contract ABI specification.
    "abi": [/* ... */],
    // Storage layout.
    "layout": {/* ... */},
    // User documentation.
    "userdoc": {/* ... */},
    // Developer documentation.
    "devdoc": {/* ... */},
    // zkvyper: EraVM assembly.
    "assembly": "\t.text\n\tincsp\t3\n\t.file\t\"main.vy\"\n...",
    // zkvyper: Warnings produced during compilation.
    "warnings": [/* ... */],
    // zkvyper: Optional bytecode hash of the minimal proxy, if the contract uses "create_minimal_proxy_to".
    "factory_deps": {
      "01000035999a1d871cf4d876ed735fa6a8f3bbeb3f94d210bf4520ed94f35654": "__VYPER_MINIMAL_PROXY_CONTRACT"
    }
  },
  // zkvyper: Metadata preimage whose hash can be appended to the bytecode.
  "extra_data": {
    // EVM version passed to the vyper compiler.
    "evm_version": "cancun",
    // LLVM extra options.
    "llvm_options": [/* ... */],
    // LLVM optimizer settings.
    // The format is "M{level}B{level}", where M = LLVM middle-end, B = LLVM back-end, and levels: 0-3 | s | z.
    "optimizer_settings": "M3B3",
    // Byte-array hash of the whole project's source code.
    "source_code_hash": [147,242,126,144,/* ... */22,153,132,218],
    // Version of vyper.
    "source_version": "0.4.0",
    // Version of zkvyper.
    "zk_version": "1.5.8"
  },
  // Version of vyper.
  "version": "0.4.0",
  // zkvyper: Version of zkvyper.
  "zk_version": "1.5.8"
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="building-zksync-compiler-with-sanitizers"><a class="header" href="#building-zksync-compiler-with-sanitizers">Building ZKsync compiler with sanitizers</a></h1>
<p>This is a guide on how to build the ZKsync Vyper compiler with sanitizers enabled.</p>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>Sanitizers are tools that help find bugs in code. They are used to detect memory corruption, leaks, and undefined behavior.
The most common sanitizers are <code>AddressSanitizer</code>, <code>MemorySanitizer</code>, and <code>ThreadSanitizer</code>.</p>
<p>If you are not familiar with sanitizers, see the <a href="https://rustc-dev-guide.rust-lang.org/sanitizers.html">official documentation</a>.</p>
<h3 id="who-is-this-guide-for"><a class="header" href="#who-is-this-guide-for">Who is this guide for?</a></h3>
<p>This guide is for developers who want to debug issues with ZKsync compilers.</p>
<h3 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h3>
<ul>
<li><a href="https://www.rust-lang.org/tools/install">Rust and Cargo</a></li>
<li><a href="https://git-scm.com/downloads">Git</a></li>
<li><a href="https://llvm.org/docs/GettingStarted.html">LLVM compiler</a></li>
</ul>
<div class="warning">
For sanitizers build to work, the host LLVM compiler version that is used to build LLVM <b>MUST</b>
have the same version as the LLVM compiler that is used internally by `rustc` to build the ZKsync compiler.
<p>You can check the LLVM version used by <code>rustc</code> by running the following command <code>rustc --version --verbose</code>.</p>
</div>
<h2 id="build-steps"><a class="header" href="#build-steps">Build steps</a></h2>
<p>The general steps to have a sanitizer enabled build include:</p>
<ol>
<li>Build the LLVM framework with the required sanitizer enabled.</li>
<li>Build <code>zkvyper</code> with the LLVM build from the previous step.</li>
</ol>
<p>Please, follow the common <a href="guides/../01-installation.html#building-from-source">installation instructions</a>
until the <code>zksync-llvm build</code> step.</p>
<p>This guide assumes the build with <code>AddressSanitizer</code> enabled.</p>
<h3 id="build-llvm-with-sanitizer-enabled"><a class="header" href="#build-llvm-with-sanitizer-enabled">Build LLVM with sanitizer enabled</a></h3>
<p>When building LLVM, use <code>--sanitizer &lt;sanitizer&gt;</code> option and set build type to <code>RelWithDebInfo</code>:</p>
<pre><code class="language-shell">zksync-llvm build --sanitizer=Address --build-type=RelWithDebInfo
</code></pre>
<div class="warning">
Please note that the default Apple Clang compiler is not compatible with Rust.
You need to install LLVM using Homebrew and specify the path to the LLVM compiler in the `--extra-args` option.
For example:
</div>
<pre><code class="language-shell">zksync-llvm build --sanitizer=Address \
  --extra-args '\-DCMAKE_C_COMPILER=/opt/homebrew/opt/llvm/bin/clang' \
               '\-DCMAKE_CXX_COMPILER=/opt/homebrew/opt/llvm/bin/clang++'
</code></pre>
<h3 id="build-zkvyper-with-sanitizer-enabled"><a class="header" href="#build-zkvyper-with-sanitizer-enabled">Build zkvyper with sanitizer enabled</a></h3>
<p>To build the ZKsync compiler with sanitizer enabled, you need to set the <code>RUSTFLAGS</code> environment variable
to <code>-Z sanitizer=address</code> and run the <code>cargo build</code> command.
Sanitizers build is the feature that is available only for the nightly Rust compiler, it is recommended
to set <code>RUSTC_BOOTSTRAP=1</code> environment variable before the build.</p>
<p>It is also mandatory to use <code>--target</code> option to specify the target architecture. Otherwise, the build will fail.
Please, check the table below to find the correct target for your platform.</p>
<div class="table-wrapper"><table><thead><tr><th>Platform</th><th>LLVM Target Triple</th></tr></thead><tbody>
<tr><td>Linux arm64</td><td><code>aarch64-unknown-linux-gnu</code></td></tr>
<tr><td>Linux x86</td><td><code>x86_64-unknown-linux-gnu</code></td></tr>
<tr><td>macOS arm64</td><td><code>aarch64-apple-darwin</code></td></tr>
<tr><td>macOS x86</td><td><code>x86_64-apple-darwin</code></td></tr>
</tbody></table>
</div>
<p>Additionally, for proper reports symbolization it is recommended to set the <code>ASAN_SYMBOLIZER_PATH</code> environment variable.
For more info, see <a href="https://clang.llvm.org/docs/AddressSanitizer.html#id4">symbolizing reports</a> section of LLVM documentation.</p>
<p>For example, to build the ZKsync compiler for macOS arm64 with <code>AddressSanitizer</code> enabled, run the following command:</p>
<pre><code class="language-shell">export RUSTC_BOOTSTRAP=1
export ASAN_SYMBOLIZER_PATH=$(which llvm-symbolizer) # check the path to llvm-symbolizer
TARGET=aarch64-apple-darwin # Change to your target
RUSTFLAGS="-Z sanitizer=address" cargo test --target=${TARGET}
</code></pre>
<p>Congratulations! You have successfully built the ZKsync compiler with sanitizers enabled.</p>
<p>Please, refer to the <a href="https://rustc-dev-guide.rust-lang.org/sanitizers.html">official documentation</a>
for more information on how to use sanitizers and their types.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="js/version-box.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
